<!doctype html>
<title>Test Client Web Page</title>
<meta charset="utf-8">
<script type="text/javascript" src="//api.filepicker.io/v1/filepicker.js"></script>
<h3>留言板</h3><p><a href="http://127.0.0.1:1234/login" style="float: right;">Login</a>
<a href="http://127.0.0.1:1234/logout" style="float: right;">Logout</a></p>
nickname<input id="user-name" autofocus><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input id="user-input" autofocus>
<input type="filepicker" data-fp-apikey="Axfazq9tS02UdbRcWFmVvz" data-fp-mimetypes="*/*" data-fp-container="modal" onchange="console.log(event.fpfile.url);"><br>
<image src="images/1.gif"/><image src="images/2.gif"/><image src="images/3.jpg"/><image src="images/4.jpg"/><image src="images/5.jpg"/>
<image id="userimage" src="https://www.filepicker.io/api/file/tOuSNyxOSOWx7L4dKR04"/><br>
<button id="submit-btn">Submit</button>
<button id="refresh-btn">Refresh</button>
<form>
sort by
<input type="radio" name="sorting" id="c2" value="timeL" checked="true"> latest
<input type="radio" name="sorting" id="c1" value="timeF"> first
<input type="radio" name="sorting" id="c3" value="nickname"> nickname
<input type="radio" name="sorting" id="c4" value="length"> length
</form>
<form>
<input type="radio" name="number" id="n1" value="timeL" checked="true"> 10
<input type="radio" name="number" id="n2" value="timeF"> 20
<input type="radio" name="number" id="all" value="length" checked="true"> all
</form>
<ul id="list-of-data"></ul>
<script>
var inputElmname =document.getElementById('user-name');
var inputElm = document.getElementById('user-input');
var submitBtn = document.getElementById('submit-btn');
var refreshBtn = document.getElementById('refresh-btn');
var listElm = document.getElementById('list-of-data');
var nicknametocode=function(nickname){
  var number=0;
  var length=nickname.toString().length;
  var name=nickname.toString();
  for(var i=0;i<length;i++){
    number=number+name.substr(i,i+1).charCodeAt(0);
  }
  return number;
}

var retrieveAllDataFromServer = function () {
  var xhr = new XMLHttpRequest();
  xhr.open('POST', 'http://127.0.0.1:1234/retrieve');
  xhr.onload = function () {
   console.log('Got response of HTTP POST /retrieve:' +this.responseText);
   
   var JSON_string = this.responseText;
   var arr = JSON.parse(JSON_string);
   var number;
   if(document.getElementById('n1').checked){var L=[10,arr.length];number=Math.min.apply(null,L);}
   else if(document.getElementById('n2').checked){var L=[20,arr.length];number=Math.min.apply(null,L);}
   else{number=arr.length}
   if(document.getElementById('c2').checked){
     for (var i = 0; i < number; i += 1) {
       var liElm = document.createElement('li');
       liElm.textContent =JSON.parse(arr[i])[0]+" : "+JSON.parse(arr[i])[1]+" at "+JSON.parse(arr[i])[2];
       listElm.appendChild(liElm);
     }
   }//c2
   else if(document.getElementById('c1').checked){
     for (var i = arr.length-1 ;i > (arr.length-number-1); i -= 1) {
     var liElm = document.createElement('li');
     liElm.textContent =JSON.parse(arr[i])[0]+" : "+JSON.parse(arr[i])[1]+" at "+JSON.parse(arr[i])[2];
     listElm.appendChild(liElm);
     }
   }//c1
   else if(document.getElementById('c3').checked){
     var l=1;//string length
     var check=0;
     while(check<number){
     for (var i=0; i<arr.length; i += 1) {
       if(check>number-1){break;}
       if(l==nicknametocode( JSON.parse(arr[i])[0])){
         var liElm = document.createElement('li');
         liElm.textContent =JSON.parse(arr[i])[0]+" : "+JSON.parse(arr[i])[1]+" at "+JSON.parse(arr[i])[2];
         listElm.appendChild(liElm);
         check+=1;//find one

       }
     }
     l+=1;
     }
   }//c3
   else {
     var l=1;//string length
     var check=0;
     while(check<number){
     for (var i=0; i<arr.length; i += 1) {
       if(check>number-1){break;}
       if(l==JSON.parse(arr[i])[1].toString().length){
         var liElm = document.createElement('li');
         liElm.textContent =JSON.parse(arr[i])[0]+" : "+JSON.parse(arr[i])[1]+" at "+JSON.parse(arr[i])[2];
         listElm.appendChild(liElm);
         check+=1;//find one
       }
     }
     l+=1;
     }
}//c4

};//onload
xhr.send();
};//retrieveAllDataFromServer

refreshBtn.addEventListener('click', function () {
while (listElm.firstChild) {
listElm.removeChild(listElm.firstChild);
}
retrieveAllDataFromServer();
});

retrieveAllDataFromServer();

var postDataToServer = function (data) {
var xhr = new XMLHttpRequest();
xhr.open('POST', 'http://127.0.0.1:1234/push');
xhr.onload = function () {
console.log('Got response of POST /push:' +
this.responseText);
};
xhr.send(data);
};

submitBtn.addEventListener('click', function () {
inputElmname.value=inputElmname.value.trim();
inputElm.value = inputElm.value.trim();
if (inputElmname.value !==''){
location.reload();
if (inputElm.value !== '') {
var arr=[inputElmname.value,inputElm.value];
postDataToServer(JSON.stringify(arr));
inputElm.value = '';
}
}
});

</script>
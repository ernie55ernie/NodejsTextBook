<!doctype html>
<title>Test Client Web Page</title>
<meta charset="utf-8">

<h3>留言板</h3>
nickname<input id="user-name" autofocus><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input id="user-input" autofocus>
<button id="submit-btn">Submit</button>
<button id="refresh-btn">Refresh</button>
<form>
sort by
<input type="radio" name="sorting" id="c2" value="timeL" checked="true"> latest
<input type="radio" name="sorting" id="c1" value="timeF"> first
<input type="radio" name="sorting" id="c3" value="top ten"> top ten
<input type="radio" name="sorting" id="c4" value="length"> length
</form>
<ul id="list-of-data"></ul>

<script>
var inputElmname =document.getElementById('user-name');
var inputElm = document.getElementById('user-input');
var submitBtn = document.getElementById('submit-btn');
var refreshBtn = document.getElementById('refresh-btn');
var listElm = document.getElementById('list-of-data');
//var moment = require('moment');//data time

var retrieveAllDataFromServer = function () {
  var xhr = new XMLHttpRequest();
  xhr.open('POST', 'http://127.0.0.1:1234/retrieve');
  xhr.onload = function () {
    console.log('Got response of HTTP POST /retrieve:' +
        this.responseText);

    var JSON_string = this.responseText;
    var arr = JSON.parse(JSON_string);
    if(document.getElementById('c2').checked){
      for (var i = 0, len = arr.length; i < len; i += 1) {
        var liElm = document.createElement('li');
        liElm.textContent =JSON.parse(arr[i])[0]+" : "+JSON.parse(arr[i])[1]+" at "+JSON.parse(arr[i])[2];
        listElm.appendChild(liElm);
      }
    }//c2
    else if(document.getElementById('c1').checked){
      for (var i = arr.length-1; i > -1; i -= 1) {
        var liElm = document.createElement('li');
        liElm.textContent =JSON.parse(arr[i])[0]+" : "+JSON.parse(arr[i])[1]+" at "+JSON.parse(arr[i])[2];
        listElm.appendChild(liElm);
      }
    }//c1
    else /*if(document.getElementById('c3').checked)*/{
      var L=[15,arr.length];
      for (var i = (arr.length-(Math.min.apply(null,L))); i < arr.length; i += 1) { //check if length<10
        var liElm = document.createElement('li');
        liElm.textContent =JSON.parse(arr[i])[0]+" : "+JSON.parse(arr[i])[1]+" at "+JSON.parse(arr[i])[2];
        listElm.appendChild(liElm);
      }
    }//c3
    /*else {
      var l=1;//string length
      var check=0
      while(check<arr.length){
        for (var i=0; i<arr.length; i += 1) {
          if(l==JSON.stringify(arr[i]).length){
            var liElm = document.createElement('li');
            liElm.textContent =JSON.parse(arr[i])[0]+" : "+JSON.parse(arr[i])[1]+" at "+JSON.parse(arr[i])[2];
            listElm.appendChild(liElm);
            check+=1;//find one
          ]
        }
      l+=1;
      }
    }//c4    
*/
  };//onload
  xhr.send();
};//retrieveAllDataFromServer

refreshBtn.addEventListener('click', function () {
  while (listElm.firstChild) {
    listElm.removeChild(listElm.firstChild);
  }
  retrieveAllDataFromServer();
});

retrieveAllDataFromServer();

var postDataToServer = function (data) {
  var xhr = new XMLHttpRequest();
  xhr.open('POST', 'http://127.0.0.1:1234/push');
  xhr.onload = function () {
    console.log('Got response of POST /push:' +
        this.responseText);
  };
  xhr.send(data);
};

submitBtn.addEventListener('click', function () {
  inputElmname.value=inputElmname.value.trim();
  inputElm.value = inputElm.value.trim();
  if (inputElmname.value !==''){
    location.reload();
    if (inputElm.value !== '') {
    var arr=[inputElmname.value,inputElm.value];
    postDataToServer(JSON.stringify(arr));
    inputElm.value = '';
    }
  }
});

</script>
